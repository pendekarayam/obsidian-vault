<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Standard Cipher Protocol — AES-256-GCM</title>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#05060a; --card:#0f1117; --accent:#00FFCC; --muted:#9aa; --danger:#ff6666; --text:#e9f7f3;
  }
  *{box-sizing:border-box}
  body{font-family:'Fira Code',monospace;background:linear-gradient(180deg,#020207,#071021);color:var(--text);margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
  .wrap{width:100%;max-width:980px;background:var(--card);border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,.03);box-shadow:0 10px 40px rgba(0,0,0,.6)}
  h1{margin:0 0 6px;color:var(--accent)}
  p.lead{margin:0 0 14px;color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{font-size:12px;color:var(--accent);display:block;margin-bottom:6px}
  textarea,input{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:#060609;color:var(--accent);font-family:inherit}
  textarea{min-height:140px;white-space:pre-wrap}
  .row{display:flex;gap:8px;align-items:center}
  button{background:var(--accent);color:#000;padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--text)}
  .muted{color:var(--muted);font-size:12px}
  .full{grid-column:1/-1}
  .actions{display:flex;gap:8px;justify-content:flex-end}
  .note{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
  .error{color:var(--danger);font-weight:700}
  @media(max-width:780px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <main class="wrap" role="main" aria-labelledby="title">
    <h1 id="title">Standard Cipher Protocol</h1>
    <p class="lead">AES-256-GCM + PBKDF2 (client-side). Output = Base64(salt||iv||ciphertext). Tidak ada komunikasi jaringan.</p>

    <section class="grid" aria-label="Standard cipher UI">
      <!-- Plaintext -->
      <div>
        <label for="plaintext">Plaintext — Pesan Asli</label>
        <textarea id="plaintext" placeholder="Tulis pesan yang ingin dienkripsi..."></textarea>

        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="password" type="text" placeholder="Password (gunakan password kuat)" />
          <input id="iter" type="number" value="250000" title="Iterations" style="width:130px"/>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="encryptBtn">Enkripsi →</button>
          <button id="genBtn" class="ghost" title="Generate random password">Generate Password</button>
          <button id="exportPlainBtn" class="ghost">Export Plain (.txt)</button>
          <div style="flex:1"></div>
        </div>

        <div style="margin-top:10px" class="muted">PBKDF2 iterations default: <strong>250,000</strong>. Untuk testing turunkan angka.</div>
      </div>

      <!-- Ciphertext -->
      <div>
        <label for="ciphertext">Ciphertext (Base64)</label>
        <textarea id="ciphertext" placeholder="Hasil enkripsi akan muncul di sini..."></textarea>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="copyCipherBtn" class="ghost">Salin Ciphertext</button>
          <button id="saveCipherBtn" class="ghost">Save Cipher (.txt)</button>
          <button id="loadCipherBtn" class="ghost">Load Cipher (.txt)</button>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(255,255,255,0.03)">

        <label for="decryptPassword">Password untuk Dekripsi</label>
        <input id="decryptPassword" type="text" placeholder="Masukkan password untuk dekripsi (sama seperti saat enkripsi)" />

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="decryptBtn">← Dekripsi</button>
          <button id="copyPlainBtn" class="ghost">Salin Plaintext</button>
        </div>
      </div>

      <!-- Info -->
      <div class="full">
        <div style="display:flex;gap:12px;align-items:center">
          <div style="flex:1" class="note">
            <strong>Format output:</strong> <code>Base64(salt(16B) || iv(12B) || ciphertext)</code>.
            Simpan ciphertext apa adanya—jangan memodifikasinya. Jika iterasi diganti saat enkripsi, gunakan nilai yang sama saat dekripsi.
          </div>
          <div style="width:220px;text-align:right">
            <div id="status" class="muted">Ready</div>
            <div style="margin-top:8px" class="muted" id="warning"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
/* Standard Cipher Protocol — AES-256-GCM + PBKDF2 (client-side)
   - salt: 16 bytes
   - iv:   12 bytes
   - PBKDF2 iterations: adjustable (default 250000)
   - Output: base64(salt||iv||ciphertext)
   Security notes: No network calls. Do NOT store password in public repo. Keep ciphertext intact.
*/

const $ = id => document.getElementById(id);
const setStatus = txt => { $('status').textContent = txt; };
const setWarn = txt => { $('warning').textContent = txt; };

function bufferToBase64(buf){
  return btoa(String.fromCharCode.apply(null,new Uint8Array(buf)));
}
function base64ToBuffer(b64){
  return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
}

async function deriveKey(password, salt, iterations=250000){
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: iterations, hash: 'SHA-512' },
    baseKey,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt','decrypt']
  );
}

async function encryptText(plaintext, password, iterations){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(password, salt, iterations);
  const encoded = new TextEncoder().encode(plaintext);
  const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encoded);
  const combined = new Uint8Array(salt.length + iv.length + ct.byteLength);
  combined.set(salt, 0);
  combined.set(iv, salt.length);
  combined.set(new Uint8Array(ct), salt.length + iv.length);
  return bufferToBase64(combined.buffer);
}

async function decryptText(base64Data, password, iterations){
  const combined = base64ToBuffer(base64Data);
  if (combined.length < (16+12+1)) throw new Error('Data tidak valid / terpotong.');
  const salt = combined.slice(0,16);
  const iv = combined.slice(16,28);
  const ciphertext = combined.slice(28);
  const key = await deriveKey(password, salt, iterations);
  const plainBuf = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext);
  return new TextDecoder().decode(plainBuf);
}

/* UI wiring */
$('encryptBtn').addEventListener('click', async () => {
  const pt = $('plaintext').value;
  const pw = $('password').value;
  const iter = Math.max(1000, parseInt($('iter').value,10) || 250000);
  if (!pt) { setStatus('Isi plaintext terlebih dahulu.'); return; }
  if (!pw) { setStatus('Password wajib diisi.'); return; }
  try {
    setStatus('Mengenkripsi ...');
    const out = await encryptText(pt, pw, iter);
    $('ciphertext').value = out;
    setStatus('Enkripsi selesai — salin/save ciphertext.');
    setWarn('');
  } catch (e) {
    console.error(e);
    setStatus('Enkripsi gagal.');
    setWarn('Error: ' + (e.message || e));
  }
});

$('decryptBtn').addEventListener('click', async () => {
  const ct = $('ciphertext').value.trim();
  const pw = $('decryptPassword').value || $('password').value;
  const iter = Math.max(1000, parseInt($('iter').value,10) || 250000);
  if (!ct) { setStatus('Masukkan ciphertext untuk didekripsi.'); return; }
  if (!pw) { setStatus('Password wajib diisi.'); return; }
  try {
    setStatus('Mendekripsi ...');
    const pt = await decryptText(ct, pw, iter);
    $('plaintext').value = pt;
    setStatus('Dekripsi berhasil.');
    setWarn('');
  } catch (e) {
    console.error(e);
    setStatus('Dekripsi gagal.');
    setWarn('Dekripsi gagal: password salah, iterasi tidak sama, atau data korup.');
  }
});

$('copyCipherBtn').addEventListener('click', async () => {
  const txt = $('ciphertext').value;
  if (!txt) { setStatus('Tidak ada ciphertext untuk disalin.'); return; }
  try {
    if (navigator.clipboard) await navigator.clipboard.writeText(txt);
    else { const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
    setStatus('Ciphertext tersalin.');
  } catch { setStatus('Gagal menyalin ciphertext.'); }
});

$('copyPlainBtn').addEventListener('click', async () => {
  const txt = $('plaintext').value;
  if (!txt) { setStatus('Tidak ada plaintext untuk disalin.'); return; }
  try {
    if (navigator.clipboard) await navigator.clipboard.writeText(txt);
    else { const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
    setStatus('Plaintext tersalin.');
  } catch { setStatus('Gagal menyalin plaintext.'); }
});

$('genBtn').addEventListener('click', () => {
  const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
  let pw = '';
  for (let i=0;i<24;i++) pw += charset.charAt(Math.floor(Math.random()*charset.length));
  $('password').value = pw;
  $('decryptPassword').value = pw;
  setStatus('Password random (24 chars) di-generate. Simpan dengan aman.');
});

$('exportPlainBtn').addEventListener('click', () => {
  const pt = $('plaintext').value;
  if (!pt) { setStatus('Tidak ada plaintext untuk diexport.'); return; }
  const blob = new Blob([pt], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'plaintext.txt'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  setStatus('Plaintext diexport sebagai plaintext.txt');
});

$('saveCipherBtn').addEventListener('click', () => {
  const ct = $('ciphertext').value;
  if (!ct) { setStatus('Tidak ada ciphertext untuk disimpan.'); return; }
  const blob = new Blob([ct], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ciphertext.txt'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  setStatus('Ciphertext disimpan sebagai ciphertext.txt');
});

$('loadCipherBtn').addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.txt,text/plain';
  input.onchange = e => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      $('ciphertext').value = String(reader.result).trim();
      setStatus('Ciphertext dimuat dari file.');
    };
    reader.readAsText(f);
  };
  input.click();
});

/* feature-detect crypto */
if (!window.crypto || !crypto.subtle) {
  setStatus('Web Crypto API tidak tersedia — enkripsi/dekripsi tidak didukung di browser ini.');
  setWarn('Gunakan browser modern (Chrome, Edge, Firefox, Safari) dan jalankan lewat http(s) (server lokal).');
  document.querySelectorAll('button,input,textarea').forEach(el => el.disabled = true);
} else {
  setStatus('Ready.');
}
</script>
</body>
</html>
