<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Encryptor — AES-GCM (PBKDF2)</title>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0b0f;--card:#11121a;--primary:#00FFCC;--muted:#9aa;--danger:#ff6666;--accent:#CC00FF;--text:#e9eef8}
    body{font-family:'Fira Code',monospace;background:linear-gradient(180deg,#020207,#071021);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;margin:0}
    .card{width:100%;max-width:920px;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 8px 40px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.03)}
    h1{margin:0 0 8px;font-size:20px;color:var(--primary)}
    p.lead{margin:.25rem 0 1rem;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:12px;color:var(--accent);display:block;margin-bottom:6px}
    textarea,input{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:#05050a;color:var(--primary);min-height:120px;font-family:inherit}
    input[type="text"]{min-height:40px}
    .row{display:flex;gap:8px;align-items:center}
    button{background:var(--primary);color:#000;padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--text)}
    .muted{color:var(--muted);font-size:12px}
    .full{grid-column:1/-1}
    .actions{display:flex;gap:8px;justify-content:flex-end}
    .notice{padding:8px;border-radius:6px;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.02);font-size:13px;color:var(--muted)}
    .error{color:var(--danger);font-weight:700}
    @media(max-width:760px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="card" role="application" aria-labelledby="title">
    <h1 id="title">Encryptor — AES-GCM (PBKDF2)</h1>
    <p class="lead">Enkripsi & dekripsi teks di browser menggunakan PBKDF2 + AES-GCM 256. Tidak ada data yang dikirim ke server.</p>

    <div class="grid">
      <!-- Plaintext -->
      <div>
        <label for="plaintext">Plaintext (pesan asli)</label>
        <textarea id="plaintext" placeholder="Ketik pesan yang mau dienkripsi..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="password" type="text" placeholder="Password (gunakan password yang kuat)" />
          <input id="iter" type="text" value="250000" style="width:110px;" title="Iterations (PBKDF2)" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="encryptBtn">Enkripsi →</button>
          <button id="genBtn" class="ghost">Generate Random Password</button>
          <div style="flex:1"></div>
        </div>
        <div style="margin-top:10px" class="muted">PBKDF2 iterations &rarr; default 250.000 (strong). Salt dan IV di-generate otomatis per enkripsi.</div>
      </div>

      <!-- Ciphertext -->
      <div>
        <label for="ciphertext">Ciphertext (Base64)</label>
        <textarea id="ciphertext" placeholder="Hasil enkripsi akan muncul di sini..."></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="copyCipherBtn" class="ghost">Salin Ciphertext</button>
          <button id="clearCipherBtn" class="ghost">Bersihkan</button>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(255,255,255,.03)">
        <label for="decryptPassword">Password untuk dekripsi</label>
        <input id="decryptPassword" type="text" placeholder="Masukkan password untuk dekripsi (sama seperti saat enkripsi)" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="decryptBtn">← Dekripsi</button>
          <button id="copyPlainBtn" class="ghost">Salin Plaintext</button>
        </div>

      </div>

      <div class="full">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="notice" style="flex:1">
            <strong>Format:</strong> output adalah Base64 dari gabungan <code>salt(16 bytes) || iv(12 bytes) || ciphertext</code>.
            <div class="muted">Saat dekripsi, fungsi memisah salt/iv dari data. Jangan modifikasi hasil ciphertext jika ingin berhasil didekripsi.</div>
          </div>
          <div style="width:200px;text-align:right">
            <div id="status" class="muted">Ready</div>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/*
  Simple client-side encryptor (PBKDF2 + AES-GCM)
  - salt: 16 bytes
  - iv: 12 bytes
  - PBKDF2 iterations: adjustable (default 250000)
  - AES: AES-GCM 256
  - Output: base64(salt||iv||ciphertext)
*/

const $ = id => document.getElementById(id);
const status = text => { $('status').textContent = text; };

function bufferToBase64(buffer){
  return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)));
}
function base64ToBuffer(base64){
  return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
}

async function deriveKey(password, salt, iterations = 250000){
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: salt, iterations: iterations, hash: 'SHA-512' },
    baseKey,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt','decrypt']
  );
  return key;
}

async function encryptText(plainText, password, iterations){
  // generate salt & iv
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(password, salt, iterations);
  const enc = new TextEncoder();
  const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, enc.encode(plainText));
  // combined: salt || iv || ciphertext
  const combined = new Uint8Array(salt.length + iv.length + ct.byteLength);
  combined.set(salt, 0);
  combined.set(iv, salt.length);
  combined.set(new Uint8Array(ct), salt.length + iv.length);
  return bufferToBase64(combined.buffer);
}

async function decryptText(base64Data, password, iterations){
  const combined = base64ToBuffer(base64Data);
  if (combined.length < 16 + 12 + 1) throw new Error('Data tidak valid atau terpotong.');
  const salt = combined.slice(0,16);
  const iv = combined.slice(16,28);
  const ciphertext = combined.slice(28);
  const key = await deriveKey(password, salt, iterations);
  const plainBuffer = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, key, ciphertext);
  const dec = new TextDecoder();
  return dec.decode(plainBuffer);
}

/* UI wiring */
$('encryptBtn').addEventListener('click', async () => {
  const pt = $('plaintext').value;
  const pw = $('password').value;
  const iter = parseInt($('iter').value, 10) || 250000;
  if (!pt) return status('Isi plaintext dulu.');
  if (!pw) return status('Password wajib diisi untuk enkripsi.');
  try {
    status('Mengenkripsi...');
    const out = await encryptText(pt, pw, iter);
    $('ciphertext').value = out;
    status('Selesai — ciphertext siap.');
  } catch (e) {
    console.error(e);
    status('Enkripsi gagal: ' + (e.message || e));
  }
});

$('decryptBtn').addEventListener('click', async () => {
  const ct = $('ciphertext').value.trim();
  const pw = $('decryptPassword').value || $('password').value;
  const iter = parseInt($('iter').value, 10) || 250000;
  if (!ct) return status('Masukkan ciphertext untuk didekripsi.');
  if (!pw) return status('Password wajib diisi untuk dekripsi.');
  try {
    status('Mendekripsi...');
    const pt = await decryptText(ct, pw, iter);
    $('plaintext').value = pt;
    status('Dekripsi berhasil.');
  } catch (e) {
    console.error(e);
    status('Dekripsi gagal: Password salah atau data korup.');
  }
});

$('copyCipherBtn').addEventListener('click', async () => {
  const text = $('ciphertext').value;
  if (!text) return status('Tidak ada ciphertext untuk disalin.');
  try {
    if (navigator.clipboard) await navigator.clipboard.writeText(text);
    else { const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
    status('Ciphertext tersalin.');
  } catch { status('Gagal menyalin.'); }
});

$('copyPlainBtn').addEventListener('click', async () => {
  const text = $('plaintext').value;
  if (!text) return status('Tidak ada plaintext untuk disalin.');
  try {
    if (navigator.clipboard) await navigator.clipboard.writeText(text);
    else { const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
    status('Plaintext tersalin.');
  } catch { status('Gagal menyalin.'); }
});

$('clearCipherBtn').addEventListener('click', ()=> { $('ciphertext').value = ''; status('Ciphertext dibersihkan.'); });

$('genBtn').addEventListener('click', ()=> {
  // generate random password (human-unfriendly but strong)
  const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
  let pw = '';
  for (let i=0;i<24;i++) pw += charset.charAt(Math.floor(Math.random()*charset.length));
  $('password').value = pw;
  $('decryptPassword').value = pw;
  status('Password random di-generate (24 chars). Simpan di tempat aman.');
});

/* detect crypto */
if (!window.crypto || !crypto.subtle) {
  status('Warning: Web Crypto API tidak tersedia di browser ini — enkripsi tidak didukung.');
  document.querySelectorAll('button,textarea,input').forEach(el=>el.disabled=true);
} else {
  status('Ready.');
}
</script>
</body>
</html>
